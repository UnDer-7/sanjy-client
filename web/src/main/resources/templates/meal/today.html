<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <title>Today's Meals - SanJy</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/meal.css}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Today's Meals</h1>
            <nav>
                <a th:href="@{/}">Home</a>
                <a th:href="@{/diet-plan/active}">Active Plan</a>
                <a th:href="@{/meal/new}">Record Meal</a>
            </nav>
        </header>

        <main>
            <div class="summary-cards">
                <div class="summary-card planned">
                    <span class="summary-label">Planned Meals</span>
                    <span class="summary-value" th:text="${totalPlannedMeals}">0</span>
                </div>
                <div class="summary-card free">
                    <span class="summary-label">Free Meals</span>
                    <span class="summary-value" th:text="${totalFreeMeals}">0</span>
                </div>
                <div class="summary-card total">
                    <span class="summary-label">Total</span>
                    <span class="summary-value" th:text="${totalPlannedMeals + totalFreeMeals}">0</span>
                </div>
            </div>

            <!-- Filters Form -->
            <div class="filters-section">
                <form th:action="@{/meal/today}" method="get" class="filters-form">
                    <div class="filter-group">
                        <label for="consumedAtAfter">Consumed After:</label>
                        <input type="datetime-local" id="consumedAtAfter" name="consumedAtAfter"
                               th:value="${consumedAtAfter != null ? #temporals.format(consumedAtAfter, 'yyyy-MM-dd''T''HH:mm') : ''}">
                    </div>

                    <div class="filter-group">
                        <label for="consumedAtBefore">Consumed Before:</label>
                        <input type="datetime-local" id="consumedAtBefore" name="consumedAtBefore"
                               th:value="${consumedAtBefore != null ? #temporals.format(consumedAtBefore, 'yyyy-MM-dd''T''HH:mm') : ''}">
                    </div>

                    <div class="filter-group">
                        <label for="isFreeMeal">Meal Type:</label>
                        <select id="isFreeMeal" name="isFreeMeal">
                            <option value="" th:selected="${isFreeMeal == null}">All</option>
                            <option value="false" th:selected="${isFreeMeal != null && !isFreeMeal}">Planned</option>
                            <option value="true" th:selected="${isFreeMeal != null && isFreeMeal}">Free</option>
                        </select>
                    </div>

                    <div class="filter-actions">
                        <button type="submit" class="btn btn-primary">Apply Filters</button>
                        <a th:href="@{/meal/today}" class="btn btn-secondary">Clear</a>
                    </div>

                    <input type="hidden" name="pageSize" th:value="${pagedMeals.pageSize}">
                </form>
            </div>

            <div th:if="${pagedMeals.content.empty}" class="empty-state">
                <h2>No meals found</h2>
                <p>No meals match the current filters.</p>
                <a th:href="@{/meal/new}" class="btn btn-primary">Record New Meal</a>
            </div>

            <div th:if="${!pagedMeals.content.empty}" class="meals-list">
                <div class="list-header">
                    <h2>Recorded Meals</h2>
                    <a th:href="@{/meal/new}" class="btn btn-primary btn-sm">+ New Meal</a>
                </div>

                <table class="meals-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Category</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="meal : ${pagedMeals.content}">
                            <td class="time-cell">
                                <span th:text="${#temporals.format(meal.consumedAt, 'HH:mm')}">08:30</span>
                            </td>
                            <td class="meal-type-cell">
                                <strong th:text="${meal.mealType.name}">Breakfast</strong>
                                <small th:text="'(scheduled: ' + ${#temporals.format(meal.mealType.scheduledTime, 'HH:mm')} + ')'">(06:20)</small>
                            </td>
                            <td class="description-cell">
                                <!-- Planned Meal -->
                                <div th:if="${!meal.isFreeMeal}">
                                    <span class="option-badge" th:text="'Option ' + ${meal.standardOption.optionNumber}">Option 1</span>
                                    <p th:text="${meal.standardOption.description}">Option description</p>
                                </div>
                                <!-- Free Meal -->
                                <div th:if="${meal.isFreeMeal}">
                                    <p th:text="${meal.freeMealDescription}">Free meal description</p>
                                </div>
                            </td>
                            <td class="quantity-cell">
                                <span th:text="${meal.quantity} + ' ' + ${meal.unit}">1.0 serving</span>
                            </td>
                            <td class="category-cell">
                                <span th:if="${!meal.isFreeMeal}" class="badge badge-planned">Planned</span>
                                <span th:if="${meal.isFreeMeal}" class="badge badge-free">Free</span>
                            </td>
                            <td class="notes-cell">
                                <span th:text="${meal.notes}" th:if="${meal.notes != null}">-</span>
                                <span th:if="${meal.notes == null}" class="text-muted">-</span>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- Pagination Footer -->
                <div class="pagination-footer">
                    <div class="pagination-info">
                        <span th:text="'Page ' + ${pagedMeals.currentPage + 1} + ' of ' + ${pagedMeals.totalPages}">Page 1 of 5</span>
                        <span class="separator">|</span>
                        <span th:text="${pagedMeals.totalItems} + ' results'">100 results</span>
                    </div>

                    <div class="pagination-controls">
                        <!-- Previous button -->
                        <a th:if="${pagedMeals.currentPage > 0}"
                           th:href="@{/meal/today(pageNumber=${pagedMeals.currentPage - 1}, pageSize=${pagedMeals.pageSize},
                                     consumedAtAfter=${consumedAtAfter}, consumedAtBefore=${consumedAtBefore}, isFreeMeal=${isFreeMeal})}"
                           class="page-link">&lt;</a>
                        <span th:if="${pagedMeals.currentPage == 0}" class="page-link disabled">&lt;</span>

                        <!-- Page numbers -->
                        <th:block th:each="i : ${#numbers.sequence(0, pagedMeals.totalPages - 1)}">
                            <a th:if="${i == pagedMeals.currentPage}"
                               class="page-link active"
                               th:text="${i}">0</a>
                            <a th:if="${i != pagedMeals.currentPage}"
                               th:href="@{/meal/today(pageNumber=${i}, pageSize=${pagedMeals.pageSize},
                                         consumedAtAfter=${consumedAtAfter}, consumedAtBefore=${consumedAtBefore}, isFreeMeal=${isFreeMeal})}"
                               class="page-link"
                               th:text="${i}">0</a>
                        </th:block>

                        <!-- Next button -->
                        <a th:if="${pagedMeals.currentPage < pagedMeals.totalPages - 1}"
                           th:href="@{/meal/today(pageNumber=${pagedMeals.currentPage + 1}, pageSize=${pagedMeals.pageSize},
                                     consumedAtAfter=${consumedAtAfter}, consumedAtBefore=${consumedAtBefore}, isFreeMeal=${isFreeMeal})}"
                           class="page-link">&gt;</a>
                        <span th:if="${pagedMeals.currentPage >= pagedMeals.totalPages - 1}" class="page-link disabled">&gt;</span>
                    </div>

                    <div class="page-size-selector">
                        <label for="pageSize">Items per page:</label>
                        <select id="pageSize" name="pageSize" onchange="changePageSize(this.value)">
                            <option value="10" th:selected="${pagedMeals.pageSize == 10}">10</option>
                            <option value="20" th:selected="${pagedMeals.pageSize == 20}">20</option>
                            <option value="50" th:selected="${pagedMeals.pageSize == 50}">50</option>
                            <option value="100" th:selected="${pagedMeals.pageSize == 100}">100</option>
                        </select>
                    </div>
                </div>

                <script th:inline="javascript">
                    function changePageSize(newSize) {
                        const url = new URL(window.location);
                        url.searchParams.set('pageSize', newSize);
                        url.searchParams.set('pageNumber', '0'); // Reset to first page
                        window.location.href = url.toString();
                    }
                </script>
            </div>
        </main>

        <footer>
            <p>&copy; 2025 SanJy - Food Control System</p>
        </footer>
    </div>
</body>
</html>
