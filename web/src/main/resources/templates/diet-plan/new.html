<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Diet Plan - SanJy</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/diet-plan.css}">
    <style>
        /* Loading Overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: white;
            margin-top: 20px;
            font-size: 18px;
            font-weight: 500;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Styles */

        /* Base responsive container */
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* Responsive form rows */
        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .form-row .form-group {
            flex: 1;
            min-width: 250px;
        }

        /* Upload section responsive */
        .upload-section {
            margin-bottom: 30px;
        }

        .upload-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .upload-controls input[type="file"] {
            flex: 1;
            min-width: 200px;
        }

        .upload-controls button {
            white-space: nowrap;
        }

        /* Form actions responsive */
        .form-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .form-actions .btn {
            min-width: 120px;
        }

        /* Meal type blocks */
        .meal-type-block {
            margin-bottom: 25px;
        }

        .meal-type-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        /* Options section */
        .options-section {
            margin-top: 20px;
        }

        .option-block {
            margin-bottom: 15px;
        }

        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 8px;
        }

        /* Navigation responsive */
        header nav {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* Tablet and below (max-width: 1024px) */
        @media (max-width: 1024px) {
            .container {
                padding: 0 20px;
            }

            .form-row .form-group {
                min-width: 200px;
            }

            header h1 {
                font-size: 1.8em;
            }
        }

        /* Mobile (max-width: 768px) */
        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }

            /* Stack form rows vertically on mobile */
            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .form-row .form-group {
                min-width: 100%;
                width: 100%;
            }

            /* Upload controls stack vertically */
            .upload-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .upload-controls input[type="file"] {
                width: 100%;
                min-width: 100%;
            }

            .upload-controls button {
                width: 100%;
            }

            /* Form actions full width */
            .form-actions {
                flex-direction: column;
            }

            .form-actions .btn {
                width: 100%;
                min-width: 100%;
            }

            /* Header responsive */
            header {
                text-align: center;
            }

            header h1 {
                font-size: 1.5em;
                margin-bottom: 15px;
            }

            header nav {
                flex-direction: column;
                gap: 10px;
            }

            header nav a {
                display: block;
                padding: 10px;
                text-align: center;
            }

            /* Meal type header stack on mobile */
            .meal-type-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .meal-type-header h3 {
                width: 100%;
                margin-bottom: 10px;
            }

            .meal-type-header .btn {
                width: 100%;
            }

            /* Option header responsive */
            .option-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .option-header .btn {
                width: 100%;
            }

            /* Add buttons full width on mobile */
            .btn-add {
                width: 100%;
                display: block;
            }

            /* Section divider spacing */
            .section-divider {
                margin: 20px 0;
            }

            /* Loading text smaller on mobile */
            .loading-text {
                font-size: 16px;
                padding: 0 20px;
                text-align: center;
            }
        }

        /* Extra small mobile (max-width: 480px) */
        @media (max-width: 480px) {
            .container {
                padding: 0 5px;
            }

            header h1 {
                font-size: 1.3em;
            }

            .help-text {
                font-size: 0.9em;
            }

            .form-section h2 {
                font-size: 1.3em;
            }

            .loading-spinner {
                width: 40px;
                height: 40px;
            }

            .loading-text {
                font-size: 14px;
            }
        }

        /* Landscape mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .form-row {
                flex-direction: row;
            }

            .form-row .form-group {
                min-width: calc(50% - 10px);
            }

            header nav {
                flex-direction: row;
                justify-content: center;
            }
        }

        /* Desktop enhancements (min-width: 1200px) */
        @media (min-width: 1200px) {
            .container {
                padding: 0 30px;
            }

            .form-row .form-group {
                min-width: 300px;
            }
        }

        /* Success Message Styles */
        .success-message {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 6px;
            padding: 15px 20px;
            margin-bottom: 20px;
            animation: slideDown 0.3s ease-out;
        }

        .success-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .success-icon {
            background-color: #28a745;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
            font-size: 16px;
        }

        .success-text {
            flex: 1;
            color: #155724;
        }

        .success-text strong {
            display: block;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .success-text p {
            margin: 0;
            font-size: 14px;
            line-height: 1.5;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            line-height: 1;
            color: #155724;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            transition: color 0.2s;
        }

        .close-btn:hover {
            color: #0c3d1a;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile adjustments for success message */
        @media (max-width: 768px) {
            .success-message {
                padding: 12px 15px;
            }

            .success-text strong {
                font-size: 15px;
            }

            .success-text p {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Processing file... Please wait</div>
    </div>
    <div class="container">
        <header>
            <h1>New Diet Plan</h1>
            <nav>
                <a th:href="@{/}">Home</a>
                <a th:href="@{/diet-plan/active}">Active Plan</a>
                <a th:href="@{/meal/today}">Today's Meals</a>
            </nav>
        </header>

        <main>
            <!-- Upload Form Section -->
            <section class="upload-section">
                <h2>Import from File</h2>
                <p class="help-text">Upload a PDF or text file to auto-fill the form</p>
                <form th:action="@{/diet-plan/upload}" method="post" enctype="multipart/form-data" class="upload-form">
                    <div class="upload-controls">
                        <input type="file" id="file" name="file" accept=".pdf,.txt,.md,text/*" required>
                        <button type="submit" class="btn btn-secondary">Upload & Fill Form</button>
                    </div>
                </form>
            </section>

            <hr class="section-divider">

            <!-- Success Message -->
            <div id="upload-success-message" class="success-message" style="display: none;">
                <div class="success-content">
                    <span class="success-icon">✓</span>
                    <div class="success-text">
                        <strong>File uploaded successfully!</strong>
                        <p>Please review the form below, make any necessary changes, and click Save to create your diet plan.</p>
                    </div>
                    <button type="button" class="close-btn" onclick="closeSuccessMessage()">&times;</button>
                </div>
            </div>

            <form th:action="@{/diet-plan}" th:object="${dietPlanRequest}" method="post" class="diet-plan-form">
                <section class="form-section">
                    <h2>Basic Information</h2>

                    <div class="form-group">
                        <label for="name">Plan Name *</label>
                        <input type="text" id="name" th:field="*{name}" required
                               placeholder="e.g. Plan #02 - Cutting">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="startDate">Start Date *</label>
                            <input type="date" id="startDate" th:field="*{startDate}" required>
                        </div>
                        <div class="form-group">
                            <label for="endDate">End Date *</label>
                            <input type="date" id="endDate" th:field="*{endDate}" required>
                        </div>
                    </div>
                </section>

                <section class="form-section">
                    <h2>Daily Macros</h2>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="dailyCalories">Calories (kcal)</label>
                            <input type="number" id="dailyCalories" th:field="*{dailyCalories}"
                                   min="0" placeholder="2266">
                        </div>
                        <div class="form-group">
                            <label for="dailyProteinInG">Protein (g)</label>
                            <input type="number" id="dailyProteinInG" th:field="*{dailyProteinInG}"
                                   min="0" placeholder="186">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="dailyCarbsInG">Carbs (g)</label>
                            <input type="number" id="dailyCarbsInG" th:field="*{dailyCarbsInG}"
                                   min="0" placeholder="288">
                        </div>
                        <div class="form-group">
                            <label for="dailyFatInG">Fat (g)</label>
                            <input type="number" id="dailyFatInG" th:field="*{dailyFatInG}"
                                   min="0" placeholder="30">
                        </div>
                    </div>
                </section>

                <section class="form-section">
                    <h2>Goals and Notes</h2>

                    <div class="form-group">
                        <label for="goal">Goal</label>
                        <textarea id="goal" th:field="*{goal}" rows="3"
                                  placeholder="e.g. Fat loss with muscle preservation"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="nutritionistNotes">Nutritionist Notes</label>
                        <textarea id="nutritionistNotes" th:field="*{nutritionistNotes}" rows="4"
                                  placeholder="Additional notes..."></textarea>
                    </div>
                </section>

                <section class="form-section">
                    <h2>Meals and Options</h2>
                    <p class="help-text">
                        Add the plan's meals with their scheduled times and food options.
                    </p>

                    <div id="meal-types-container">
                        <!-- Dynamic meal types will be added here via JavaScript -->
                    </div>

                    <button type="button" class="btn btn-add" id="add-meal-type-btn">+ Add Meal Type</button>
                </section>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save Plan</button>
                    <a th:href="@{/diet-plan/active}" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </main>

        <footer>
            <p>&copy; 2025 SanJy - Food Control System</p>
        </footer>
    </div>

    <script th:inline="javascript">
        let mealTypeIndex = 0;

        // Get meal types data from Thymeleaf (if any)
        /*<![CDATA[*/
        const mealTypesData = /*[[${dietPlanRequest.mealTypes}]]*/ null;
        /*]]>*/

        // Initialize with one meal type and set default dates
        document.addEventListener('DOMContentLoaded', function() {
            // Set default dates only if not already set
            const today = new Date();
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');

            if (!startDateInput.value) {
                startDateInput.value = today.toISOString().split('T')[0];
            }

            if (!endDateInput.value) {
                const endDate = new Date(today);
                endDate.setMonth(endDate.getMonth() + 2);
                endDateInput.value = endDate.toISOString().split('T')[0];
            }

            // Load meal types from data or create empty one
            if (mealTypesData && mealTypesData.length > 0) {
                loadMealTypesFromData(mealTypesData);
            } else {
                addMealType();
            }

            // Add loading overlay to upload form
            const uploadForm = document.querySelector('.upload-form');
            if (uploadForm) {
                uploadForm.addEventListener('submit', function(e) {
                    const fileInput = document.getElementById('file');
                    if (fileInput && fileInput.files.length > 0) {
                        document.getElementById('loading-overlay').classList.add('active');
                    }
                });
            }

            // Check if upload was successful and show success message
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('uploaded') === 'success' || (mealTypesData && mealTypesData.length > 0)) {
                showSuccessMessage();
            }
        });

        function showSuccessMessage() {
            const successMessage = document.getElementById('upload-success-message');
            if (successMessage) {
                successMessage.style.display = 'block';

                // Scroll to message
                successMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                // Auto-hide after 15 seconds
                setTimeout(function() {
                    closeSuccessMessage();
                }, 15000);
            }
        }

        function closeSuccessMessage() {
            const successMessage = document.getElementById('upload-success-message');
            if (successMessage) {
                successMessage.style.display = 'none';
            }
        }

        document.getElementById('add-meal-type-btn').addEventListener('click', function() {
            addMealType();
        });

        function loadMealTypesFromData(mealTypes) {
            mealTypes.forEach((mealType, index) => {
                addMealType(mealType.name, mealType.scheduledTime, mealType.standardOptions);
            });
        }

        function addMealType(mealName = '', scheduledTime = '', standardOptions = null) {
            const container = document.getElementById('meal-types-container');
            const index = mealTypeIndex++;

            const mealTypeDiv = document.createElement('div');
            mealTypeDiv.className = 'meal-type-block';
            mealTypeDiv.dataset.index = index;

            // Format time if provided (remove seconds)
            let timeValue = '';
            if (scheduledTime) {
                // scheduledTime comes as array [hour, minute, second] from Thymeleaf
                if (Array.isArray(scheduledTime)) {
                    const hour = String(scheduledTime[0]).padStart(2, '0');
                    const minute = String(scheduledTime[1]).padStart(2, '0');
                    timeValue = `${hour}:${minute}`;
                } else if (typeof scheduledTime === 'string') {
                    // If it's already a string, take only HH:mm
                    timeValue = scheduledTime.substring(0, 5);
                }
            }

            mealTypeDiv.innerHTML = `
                <div class="meal-type-header">
                    <h3>Meal Type #${index + 1}</h3>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeMealType(${index})">Remove</button>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="mealType-${index}-name">Meal Name *</label>
                        <input type="text" id="mealType-${index}-name"
                               name="mealTypes[${index}].name"
                               value="${mealName}"
                               required
                               placeholder="e.g. Breakfast, Lunch, Dinner">
                    </div>
                    <div class="form-group">
                        <label for="mealType-${index}-time">Scheduled Time</label>
                        <input type="time" id="mealType-${index}-time"
                               name="mealTypes[${index}].scheduledTime"
                               value="${timeValue}"
                               placeholder="HH:mm">
                    </div>
                </div>

                <div class="options-section">
                    <h4>Standard Options</h4>
                    <div class="options-container" id="options-container-${index}">
                        <!-- Options will be added here -->
                    </div>
                    <button type="button" class="btn btn-add btn-sm" onclick="addOption(${index})">+ Add Option</button>
                </div>
            `;

            container.appendChild(mealTypeDiv);

            // Add options
            if (standardOptions && standardOptions.length > 0) {
                standardOptions.forEach((option, optionIndex) => {
                    addOption(index, option.description, option.optionNumber);
                });
            } else {
                // Add first option automatically if no data
                addOption(index);
            }
        }

        function removeMealType(mealTypeIndex) {
            const mealTypes = document.querySelectorAll('.meal-type-block');
            if (mealTypes.length <= 1) {
                alert('You must have at least one meal type.');
                return;
            }

            const mealTypeBlock = document.querySelector(`.meal-type-block[data-index="${mealTypeIndex}"]`);
            if (mealTypeBlock && confirm('Remove this meal type and all its options?')) {
                mealTypeBlock.remove();
                reindexMealTypes();
            }
        }

        function addOption(mealTypeIndex, description = '', optionNumber = null) {
            const optionsContainer = document.getElementById(`options-container-${mealTypeIndex}`);
            const currentOptions = optionsContainer.querySelectorAll('.option-block').length;
            const optionIndex = currentOptions;
            const finalOptionNumber = optionNumber || (optionIndex + 1);

            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-block';
            optionDiv.dataset.optionIndex = optionIndex;

            // Escape description for HTML
            const escapedDescription = description.replace(/"/g, '&quot;').replace(/'/g, '&#39;');

            optionDiv.innerHTML = `
                <div class="option-header">
                    <span class="option-badge">Option #${finalOptionNumber}</span>
                    <button type="button" class="btn btn-danger btn-xs" onclick="removeOption(${mealTypeIndex}, ${optionIndex})">Remove</button>
                </div>
                <input type="hidden"
                       name="mealTypes[${mealTypeIndex}].standardOptions[${optionIndex}].optionNumber"
                       value="${finalOptionNumber}">
                <textarea name="mealTypes[${mealTypeIndex}].standardOptions[${optionIndex}].description"
                          required
                          rows="3"
                          placeholder="e.g. 2 slices whole grain bread -- 45g | Scrambled eggs -- 3 eggs">${description}</textarea>
            `;

            optionsContainer.appendChild(optionDiv);
        }

        function removeOption(mealTypeIndex, optionIndex) {
            const optionsContainer = document.getElementById(`options-container-${mealTypeIndex}`);
            const options = optionsContainer.querySelectorAll('.option-block');

            if (options.length <= 1) {
                alert('Each meal type must have at least one option.');
                return;
            }

            const optionBlock = optionsContainer.querySelector(`.option-block[data-option-index="${optionIndex}"]`);
            if (optionBlock) {
                optionBlock.remove();
                reindexOptions(mealTypeIndex);
            }
        }

        function reindexMealTypes() {
            const mealTypes = document.querySelectorAll('.meal-type-block');
            mealTypes.forEach((mealType, newIndex) => {
                const oldIndex = mealType.dataset.index;
                mealType.dataset.index = newIndex;

                // Update header
                mealType.querySelector('h3').textContent = `Meal Type #${newIndex + 1}`;

                // Update remove button
                const removeBtn = mealType.querySelector('.meal-type-header .btn-danger');
                removeBtn.setAttribute('onclick', `removeMealType(${newIndex})`);

                // Update meal type inputs
                mealType.querySelectorAll('input[type="text"], input[type="time"]').forEach(input => {
                    const name = input.getAttribute('name');
                    if (name) {
                        input.setAttribute('name', name.replace(/mealTypes\[\d+\]/, `mealTypes[${newIndex}]`));
                        input.id = input.id.replace(/mealType-\d+-/, `mealType-${newIndex}-`);
                    }
                });

                // Update options container id
                const optionsContainer = mealType.querySelector('.options-container');
                optionsContainer.id = `options-container-${newIndex}`;

                // Update add option button
                const addOptionBtn = mealType.querySelector('.options-section .btn-add');
                addOptionBtn.setAttribute('onclick', `addOption(${newIndex})`);

                // Reindex options within this meal type
                reindexOptions(newIndex);
            });
        }

        function reindexOptions(mealTypeIndex) {
            const optionsContainer = document.getElementById(`options-container-${mealTypeIndex}`);
            const options = optionsContainer.querySelectorAll('.option-block');

            options.forEach((option, newOptionIndex) => {
                option.dataset.optionIndex = newOptionIndex;
                const optionNumber = newOptionIndex + 1;

                // Update badge
                option.querySelector('.option-badge').textContent = `Option #${optionNumber}`;

                // Update remove button
                const removeBtn = option.querySelector('.btn-danger');
                removeBtn.setAttribute('onclick', `removeOption(${mealTypeIndex}, ${newOptionIndex})`);

                // Update hidden input
                const hiddenInput = option.querySelector('input[type="hidden"]');
                hiddenInput.setAttribute('name', `mealTypes[${mealTypeIndex}].standardOptions[${newOptionIndex}].optionNumber`);
                hiddenInput.value = optionNumber;

                // Update textarea
                const textarea = option.querySelector('textarea');
                textarea.setAttribute('name', `mealTypes[${mealTypeIndex}].standardOptions[${newOptionIndex}].description`);
            });
        }
    </script>
</body>
</html>
